#!/usr/bin/env bash
#
# Install command for claude-mm-tool
#
# Installs the ai tool to ~/.local/bin with proper venv

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

usage() {
    cat <<EOF
Usage: ./run install [OPTIONS]

Install claude-mm-tool to ~/.local/bin

Options:
  --keys    Prompt for missing API keys
  --help    Show this help message
EOF
}

main() {
    cd "$ROOT"

    local force_keys=false
    if [[ "${1:-}" == "--help" ]]; then
        usage
        exit 0
    elif [[ "${1:-}" == "--keys" ]]; then
        force_keys=true
    fi

    echo "üì¶ Installing claude-mm-tool..."

    # Create ~/.local/bin if it doesn't exist
    mkdir -p "$HOME/.local/bin"

    # Create venv at ~/.local/venvs/ai
    local venv_dir="$HOME/.local/venvs/ai"

    if [[ ! -d "$venv_dir" ]]; then
        echo "üêç Creating Python virtual environment..."
        python3 -m venv "$venv_dir"
    fi

    # Install dependencies
    echo "üìö Installing dependencies..."
    "$venv_dir/bin/pip" install -q --upgrade pip
    "$venv_dir/bin/pip" install -q -e "$ROOT"
    "$venv_dir/bin/pip" install -q -e "$ROOT[dev]"

    # Copy ai script to ~/.local/bin with venv shebang
    echo "üîß Installing ai command..."
    local ai_bin="$HOME/.local/bin/ai"
    cp "$ROOT/bin/ai" "$ai_bin"

    # Update shebang to use venv Python
    sed -i.bak "1s|.*|#!$venv_dir/bin/python3|" "$ai_bin"
    rm "$ai_bin.bak"
    chmod +x "$ai_bin"

    # Install Carapace completion if .carapace spec exists
    if [[ -f "$ROOT/.carapace/ai.yaml" ]]; then
        echo "üéØ Installing shell completions..."
        mkdir -p "$HOME/.config/carapace/specs"
        cp "$ROOT/.carapace/ai.yaml" "$HOME/.config/carapace/specs/"
        echo "  ‚úì ai.yaml"
    fi

    # Check API keys
    local config_dir="$HOME/.config/claude-mm-tool"
    local env_file="$config_dir/env"

    mkdir -p "$config_dir"

    # Check if we need to prompt for keys
    local should_prompt=false
    if [[ ! -f "$env_file" ]]; then
        should_prompt=true
        echo ""
        echo "‚öôÔ∏è  API keys not configured"
    elif [[ "$force_keys" == true ]]; then
        should_prompt=true
        echo ""
        echo "‚öôÔ∏è  Checking for missing API keys..."
    fi

    if [[ "$should_prompt" == true ]]; then
        # Parse existing keys if file exists
        local existing_openai=""
        local existing_google=""
        local existing_anthropic=""

        if [[ -f "$env_file" ]]; then
            existing_openai=$(grep "OPENAI_API_KEY" "$env_file" 2>/dev/null | cut -d'"' -f2 || true)
            existing_google=$(grep "GOOGLE_AI_API_KEY" "$env_file" 2>/dev/null | cut -d'"' -f2 || true)
            existing_anthropic=$(grep "ANTHROPIC_API_KEY" "$env_file" 2>/dev/null | cut -d'"' -f2 || true)
        fi

        echo ""

        # Prompt for each key if missing
        local openai_key="$existing_openai"
        local google_key="$existing_google"
        local anthropic_key="$existing_anthropic"

        if [[ -z "$existing_openai" ]]; then
            read -p "Enter your OpenAI API key (or press Enter to skip): " openai_key
        else
            echo "‚úì OpenAI API key already configured"
        fi

        if [[ -z "$existing_google" ]]; then
            read -p "Enter your Google AI API key (or press Enter to skip): " google_key
        else
            echo "‚úì Google AI API key already configured"
        fi

        if [[ -z "$existing_anthropic" ]]; then
            read -p "Enter your Anthropic API key (optional, press Enter to skip): " anthropic_key
        else
            echo "‚úì Anthropic API key already configured"
        fi

        # Write env file if we have at least one key
        if [[ -n "$openai_key" || -n "$google_key" || -n "$anthropic_key" ]]; then
            echo "# AI Tool API Keys" > "$env_file"
            if [[ -n "$openai_key" ]]; then
                echo "export OPENAI_API_KEY=\"$openai_key\"" >> "$env_file"
            fi
            if [[ -n "$google_key" ]]; then
                echo "export GOOGLE_AI_API_KEY=\"$google_key\"" >> "$env_file"
            fi
            if [[ -n "$anthropic_key" ]]; then
                echo "export ANTHROPIC_API_KEY=\"$anthropic_key\"" >> "$env_file"
            fi
            chmod 600 "$env_file"
            echo ""
            echo "‚úì API keys saved to $env_file"
        else
            echo ""
            echo "‚ö†Ô∏è  No API keys configured. You can add them later to:"
            echo "   $env_file"
            echo ""
            echo "   Format:"
            echo "   export OPENAI_API_KEY=\"sk-...\""
            echo "   export GOOGLE_AI_API_KEY=\"...\""
            echo "   export ANTHROPIC_API_KEY=\"sk-ant-...\"  # optional"
        fi
    else
        echo ""
        echo "‚úì API keys already configured at $env_file"
        echo "  (Use --keys flag to add missing keys)"
    fi

    echo ""
    echo "‚úÖ Installation complete!"
    echo ""
    echo "   Command: ai"
    echo "   Location: $ai_bin"
    echo "   Config: $config_dir"
    echo ""
    echo "Try: ai --help"
}

main "$@"
